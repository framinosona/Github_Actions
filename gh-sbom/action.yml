name: "ğŸ“¦ Generate SBOM with gh-sbom"
description: "Generate Software Bill of Materials (SBOM) for GitHub repositories using the gh-sbom CLI extension"
author: "Francois Raminosona"

inputs:
  repository:
    description: "Repository to generate SBOM for (format: owner/repo). Uses current repository if not specified"
    required: false
    default: ""
  format:
    description: "SBOM format to generate"
    required: false
    default: "spdx"
  include-license:
    description: "Include license information from clearlydefined.io for CycloneDX format (SPDX always includes license information)"
    required: false
    default: "false"
  output-file:
    description: "Path to save the generated SBOM file. Outputs to stdout if not specified"
    required: false
    default: ""
  github-token:
    description: "GitHub token for authentication. Uses GITHUB_TOKEN by default"
    required: false
    default: "${{ github.token }}"
  show-summary:
    description: "Whether to show the action summary"
    required: false
    default: "false"

outputs:
  sbom-format:
    description: "The format of the generated SBOM (spdx or cyclonedx)"
    value: ${{ steps.generate-sbom.outputs.sbom-format }}
  output-file:
    description: "Path to the generated SBOM file (if saved to file)"
    value: ${{ steps.generate-sbom.outputs.output-file }}
  component-count:
    description: "Number of components found in the SBOM"
    value: ${{ steps.generate-sbom.outputs.component-count }}
  exit-code:
    description: "Exit code of the gh-sbom command"
    value: ${{ steps.generate-sbom.outputs.exit-code }}
  generation-successful:
    description: "Whether the SBOM generation was successful"
    value: ${{ steps.verify-sbom.outputs.generation-successful }}
  file-created:
    description: "Whether the output file was successfully created"
    value: ${{ steps.verify-sbom.outputs.file-created }}
  file-size:
    description: "Size of the created SBOM file in bytes"
    value: ${{ steps.verify-sbom.outputs.file-size }}
  file-valid:
    description: "Whether the generated SBOM file appears to be valid"
    value: ${{ steps.verify-sbom.outputs.file-valid }}
  has-components:
    description: "Whether the SBOM contains components"
    value: ${{ steps.verify-sbom.outputs.has-components }}

runs:
  using: "composite"
  steps:
    # ================== â„¹ï¸ ==================
    - name: "â„¹ï¸ Gather environment information"
      shell: bash
      run: |
        echo "::group::â„¹ï¸ Environment Information"
        echo "::debug::Operating System: $(uname -a)"
        echo "::debug::GitHub Runner OS: $RUNNER_OS"
        echo "::debug::GitHub Runner Version: $RUNNER_VERSION"
        echo "::debug::GitHub CLI Version: $(gh --version || echo 'Not installed')"
        echo "::debug::jq Version: $(jq --version || echo 'Not installed')"
        echo "::endgroup::"

    # ================== ğŸ”’ ==================

    - name: "ğŸ”’ Mask sensitive data"
      shell: bash
      run: |
        if [ -n "${{ inputs.github-token }}" ]; then
          echo "::add-mask::${{ inputs.github-token }}"
        fi

        echo "::debug::Masked sensitive inputs"

    # ================== ğŸ“ ==================
    - name: "ğŸ“ Normalize output-file path"
      id: normalize-output-file
      uses: framinosona/github_actions/normalize-path@main
      with:
        path: ${{ inputs.output-file }}

    # ================== âœ… ==================

    - name: "âœ… Validate input : booleans"
      shell: bash
      run: |
        echo "::debug::Validating boolean inputs..."
        for param in include-license show-summary; do
          case $param in
            include-license) value="${{ inputs.include-license }}" ;;
            show-summary) value="${{ inputs.show-summary }}" ;;
          esac
          if [ -n "$value" ] && [ "$value" != "true" ] && [ "$value" != "false" ]; then
            echo "::error::Parameter $param must be 'true' or 'false', got: $value"
            exit 1
          fi
        done

        echo "âœ… Boolean inputs validation completed successfully"

    - name: "âœ… Validate input : format"
      shell: bash
      run: |
        echo "::debug::Validating format input: ${{ inputs.format }}"

        case "${{ inputs.format }}" in
          spdx|cyclonedx) ;;
          *) echo "::error::Invalid format '${{ inputs.format }}'. Must be 'spdx' or 'cyclonedx'"; exit 1 ;;
        esac

        echo "âœ… Format validation completed successfully"

    - name: "âœ… Validate input : repository"
      if: ${{ inputs.repository != '' }}
      shell: bash
      run: |
        echo "::debug::Validating repository input: ${{ inputs.repository }}"

        if [[ ! "${{ inputs.repository }}" =~ ^[a-zA-Z0-9._-]+/[a-zA-Z0-9._-]+$ ]]; then
          echo "::error::Invalid repository format '${{ inputs.repository }}'. Must be 'owner/repo'"
          exit 1
        fi

        echo "âœ… Repository format validation completed successfully"

    - name: "âœ… Validate input : output-file"
      if: ${{ inputs.output-file != '' }}
      shell: bash
      run: |
        echo "::debug::Validating output-file input: ${{ steps.normalize-output-file.outputs.normalized }}"

        # Validate output directory exists
        output_dir=$(dirname "${{ steps.normalize-output-file.outputs.normalized }}")
        if [ "$output_dir" != "." ] && [ ! -d "$output_dir" ]; then
          echo "::error file=${{ steps.normalize-output-file.outputs.normalized }}::Output directory does not exist: $output_dir"
          exit 1
        fi

        # Validate file extension matches format
        case "${{ inputs.format }}" in
          spdx)
            if [[ ! "${{ steps.normalize-output-file.outputs.normalized }}" =~ \.(json|spdx)$ ]]; then
              echo "::warning::SPDX format typically uses .json or .spdx extension"
            fi
            ;;
          cyclonedx)
            if [[ ! "${{ steps.normalize-output-file.outputs.normalized }}" =~ \.(json|xml)$ ]]; then
              echo "::warning::CycloneDX format typically uses .json or .xml extension"
            fi
            ;;
        esac

        echo "âœ… Output file validation completed successfully"

    - name: "âœ… Validate input : github-token"
      shell: bash
      run: |
        echo "::debug::Validating GitHub token..."

        if [ -z "${{ inputs.github-token }}" ]; then
          echo "::error::GitHub token is required for authentication"
          exit 1
        fi

        echo "âœ… GitHub token validation completed successfully"

    - name: "ğŸ—ï¸ Build argument list"
      id: build-args
      shell: bash
      run: |
        echo "::debug::Building argument list for gh-sbom..."

        # Start with base arguments
        ARGUMENTS=""

        # Repository argument
        if [ -n "${{ inputs.repository }}" ]; then
          ARGUMENTS="$ARGUMENTS -r '${{ inputs.repository }}'"
          echo "::debug::Using repository: ${{ inputs.repository }}"
        else
          echo "::debug::Using current repository"
        fi

        # Format argument
        if [ "${{ inputs.format }}" = "cyclonedx" ]; then
          ARGUMENTS="$ARGUMENTS -c"
          echo "::debug::Using CycloneDX format"
        else
          echo "::debug::Using SPDX format (default)"
        fi

        # License argument (only for CycloneDX)
        if [ "${{ inputs.include-license }}" = "true" ] && [ "${{ inputs.format }}" = "cyclonedx" ]; then
          ARGUMENTS="$ARGUMENTS -l"
          echo "::debug::Including license information"
        elif [ "${{ inputs.include-license }}" = "true" ] && [ "${{ inputs.format }}" = "spdx" ]; then
          echo "::debug::License information automatically included for SPDX format"
        fi

        # Trim leading space
        ARGUMENTS="${ARGUMENTS# }"

        echo "arguments=$ARGUMENTS" >> $GITHUB_OUTPUT
        echo "âœ… Argument list built successfully: $ARGUMENTS"

    # ================== ğŸ—ï¸ ==================

    - name: "ğŸ”§ Setup gh-sbom extension"
      shell: bash
      run: |
        echo "::debug::Setting up GitHub CLI and gh-sbom extension..."
        echo "::debug::GitHub CLI version: $(gh --version)"

        # Set GitHub token for authentication
        echo "${{ inputs.github-token }}" | gh auth login --with-token

        # Check if gh-sbom extension is installed
        if ! gh extension list | grep -q "advanced-security/gh-sbom"; then
          echo "::debug::Installing gh-sbom extension..."
          gh extension install advanced-security/gh-sbom
        else
          echo "::debug::gh-sbom extension already installed"
          # Optionally upgrade to latest version
          gh extension upgrade advanced-security/gh-sbom || echo "::warning::Failed to upgrade gh-sbom extension"
        fi

        echo "âœ… gh-sbom extension setup completed successfully"

    # ================== ğŸš€ ==================

    - name: "ğŸ“¦ Generate SBOM"
      id: generate-sbom
      shell: bash
      run: |
        echo "::debug::Executing SBOM generation with gh-sbom"

        # Get arguments from build step
        ARGS_STRING="${{ steps.build-args.outputs.arguments }}"

        # Convert arguments string to array
        if [ -n "$ARGS_STRING" ]; then
          eval "ARGS=($ARGS_STRING)"
        else
          ARGS=()
        fi

        echo "::debug::Command arguments: ${ARGS[*]}"

        # Execute gh sbom command
        set +e
        if [ -n "${{ inputs.output-file }}" ]; then
          echo "::debug::Saving SBOM to file: ${{ steps.normalize-output-file.outputs.normalized }}"
          gh sbom "${ARGS[@]}" > "${{ steps.normalize-output-file.outputs.normalized }}"
          exit_code=$?
        else
          echo "::debug::Outputting SBOM to stdout"
          gh sbom "${ARGS[@]}"
          exit_code=$?
        fi
        set -e

        # Set outputs
        echo "sbom-format=${{ inputs.format }}" >> $GITHUB_OUTPUT
        echo "exit-code=$exit_code" >> $GITHUB_OUTPUT

        if [ -n "${{ inputs.output-file }}" ]; then
          echo "output-file=${{ steps.normalize-output-file.outputs.normalized }}" >> $GITHUB_OUTPUT

          # Count components if file was created successfully
          if [ $exit_code -eq 0 ] && [ -f "${{ steps.normalize-output-file.outputs.normalized }}" ]; then
            if [ "${{ inputs.format }}" = "spdx" ]; then
              component_count=$(jq '.packages | length' "${{ steps.normalize-output-file.outputs.normalized }}" 2>/dev/null || echo "0")
            else
              component_count=$(jq '.components | length' "${{ steps.normalize-output-file.outputs.normalized }}" 2>/dev/null || echo "0")
            fi
            echo "component-count=$component_count" >> $GITHUB_OUTPUT
            echo "::debug::Found $component_count components"
          else
            echo "component-count=0" >> $GITHUB_OUTPUT
          fi
        else
          echo "output-file=" >> $GITHUB_OUTPUT
          echo "component-count=0" >> $GITHUB_OUTPUT
        fi

        if [ $exit_code -eq 0 ]; then
          echo "âœ… SBOM generated successfully"
        else
          echo "::error::SBOM generation failed with exit code $exit_code"
          exit $exit_code
        fi

    # ================== ï¿½ ==================
    - name: "ğŸ” Verify SBOM generation"
      id: verify-sbom
      shell: bash
      run: |
        echo "::debug::Verifying SBOM generation results..."

        # Verify exit code
        if [ "${{ steps.generate-sbom.outputs.exit-code }}" = "0" ]; then
          echo "âœ… SBOM generation completed successfully"
          echo "generation-successful=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ SBOM generation failed with exit code ${{ steps.generate-sbom.outputs.exit-code }}"
          echo "generation-successful=false" >> $GITHUB_OUTPUT
        fi

        # Verify output file if requested
        if [ -n "${{ inputs.output-file }}" ]; then
          if [ -f "${{ steps.normalize-output-file.outputs.normalized }}" ]; then
            file_size=$(wc -c < "${{ steps.normalize-output-file.outputs.normalized }}" 2>/dev/null || echo "0")
            echo "âœ… SBOM file created: ${{ steps.normalize-output-file.outputs.normalized }} ($file_size bytes)"
            echo "file-created=true" >> $GITHUB_OUTPUT
            echo "file-size=$file_size" >> $GITHUB_OUTPUT

            # Validate SBOM content (basic JSON structure check)
            if command -v jq >/dev/null 2>&1; then
              if jq empty "${{ steps.normalize-output-file.outputs.normalized }}" >/dev/null 2>&1; then
                echo "âœ… SBOM file appears to be valid JSON"
                echo "file-valid=true" >> $GITHUB_OUTPUT
              else
                echo "âš ï¸ SBOM file exists but may not be valid JSON"
                echo "file-valid=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "âš ï¸ jq not available for JSON validation"
              echo "file-valid=unknown" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ SBOM file was not created: ${{ steps.normalize-output-file.outputs.normalized }}"
            echo "file-created=false" >> $GITHUB_OUTPUT
            echo "file-size=0" >> $GITHUB_OUTPUT
            echo "file-valid=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "â­ï¸ No output file requested - SBOM sent to stdout"
          echo "file-created=not-requested" >> $GITHUB_OUTPUT
          echo "file-size=0" >> $GITHUB_OUTPUT
          echo "file-valid=not-applicable" >> $GITHUB_OUTPUT
        fi

        # Verify component count
        component_count="${{ steps.generate-sbom.outputs.component-count }}"
        if [ "$component_count" -gt 0 ]; then
          echo "âœ… Found $component_count components in SBOM"
          echo "has-components=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ No components found in SBOM or count unavailable"
          echo "has-components=false" >> $GITHUB_OUTPUT
        fi

        echo "::debug::SBOM generation verification completed"

    # ================== ï¿½ğŸ“Š ==================
    - name: "ğŸ“Š Action Summary"
      if: always() && inputs.show-summary == 'true'
      shell: bash
      run: |
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        <details><summary>ï¿½ Generate SBOM: ${{ inputs.format }}</summary>

        ## ğŸ”§ Input Parameters
        | Parameter | Value |
        |-----------|-------|
        | ğŸ“ Repository | `${{ inputs.repository || 'current repository' }}` |
        | ğŸ“‹ Format | `${{ inputs.format }}` |
        | ğŸ“„ Include License | `${{ inputs.include-license }}` |
        | ğŸ’¾ Output File | `${{ steps.normalize-output-file.outputs.normalized || 'stdout' }}` |

        ## ğŸ“¤ Action Results
        | Metric | Value |
        |--------|-------|
        | ğŸ¯ SBOM Format | `${{ steps.generate-sbom.outputs.sbom-format }}` |
        | ğŸ“ Output File | `${{ steps.generate-sbom.outputs.output-file || 'stdout' }}` |
        | ğŸ“Š Component Count | `${{ steps.generate-sbom.outputs.component-count }}` |
        | âœ… Exit Code | `${{ steps.generate-sbom.outputs.exit-code }}` |
        | ğŸ“ˆ Generation Status | `${{ steps.verify-sbom.outputs.generation-successful == 'true' && 'âœ… Success' || 'âŒ Failed' }}` |
        | ğŸ“ File Created | `${{ steps.verify-sbom.outputs.file-created }}` |
        | ğŸ“ File Size | `${{ steps.verify-sbom.outputs.file-size }} bytes` |
        | âœ… File Valid | `${{ steps.verify-sbom.outputs.file-valid }}` |
        | ğŸ“¦ Has Components | `${{ steps.verify-sbom.outputs.has-components }}` |

        ## âš™ï¸ Process Details
        | Step | Status |
        |------|--------|
        | âœ… Input Validation | `âœ… Completed` |
        | ğŸ—ï¸ Argument Building | `${{ steps.build-args.outcome == 'success' && 'âœ… Completed' || 'âŒ Failed' }}` |
        | ğŸ”§ Extension Setup | `âœ… Completed` |
        | ğŸ“¦ Generate SBOM | `${{ steps.generate-sbom.outcome == 'success' && 'âœ… Completed' || 'âŒ Failed' }}` |
        | ğŸ” SBOM Verification | `${{ steps.verify-sbom.outcome == 'success' && 'âœ… Completed' || 'âŒ Failed' }}` |

        </details>
        EOF

branding:
  icon: "package"
  color: "blue"

# gh sbom --help
# Usage of /Users/framinosona/.local/share/gh/extensions/gh-sbom/gh-sbom:
#   --cyclonedx           Use CycloneDX SBOM format. Default is to use SPDX.
#   --license             Include license information from clearlydefined.io for CycloneDX format (SPDX always includes license information).
#   --repository string   Repository to query. Current directory used by default.
