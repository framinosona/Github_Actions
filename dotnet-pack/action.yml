name: "ğŸ“¦ Pack .NET Project"
description: "Pack .NET projects into NuGet packages with comprehensive configuration options"
author: "Francois Raminosona"

inputs:
  # Arguments passed to dotnet
  path:
    description: "Path to the project file, solution file, or directory to operate on"
    required: false
    default: ""
  arguments:
    description: "Additional arguments to pass to the dotnet command"
    required: false
    default: ""
  working-directory:
    description: "Working directory for the command"
    required: false
    default: "."
  verbosity:
    description: "Force a specific verbosity level (overrides auto-detection)"
    required: false
    default: ""
  nologo:
    description: "Suppress the Microsoft logo and startup information"
    required: false
    default: "true"
  no-restore:
    description: "Skip automatic restore"
    required: false
    default: "false"
  no-build:
    description: "Skip building the project before packing"
    required: false
    default: "false"
  configuration:
    description: "Build configuration to use (e.g., 'Debug', 'Release')"
    required: false
    default: "Release"
  output:
    description: "Output directory to place built packages in"
    required: false
    default: ""
  artifacts-path:
    description: "The artifacts path. All output from the project, including build, publish, and pack output, will go in subfolders under the specified path."
    required: false
    default: ""
  show-summary:
    description: "Whether to show the action summary"
    required: false
    default: "false"

  # Arguments unique to pack command
  include-symbols:
    description: "Include packages with symbols in addition to regular packages in output directory"
    required: false
    default: "false"
  include-source:
    description: "Include PDBs and source files. Source files go into the 'src' folder in the resulting nuget package"
    required: false
    default: "false"
  serviceable:
    description: "Set the serviceable flag in the package"
    required: false
    default: "false"
  version-suffix:
    description: "Set the value of the $(VersionSuffix) property to use when building the project"
    required: false
    default: ""
  disable-build-servers:
    description: "Force ignoring any persistent build servers"
    required: false
    default: "false"
  use-current-runtime:
    description: "Use current runtime as the target runtime"
    required: false
    default: "false"

outputs:
  exit-code:
    description: "Exit code of the dotnet pack command"
    value: ${{ steps.run-dotnet.outputs.exit-code }}
  executed-command:
    description: "The actual command that was executed"
    value: ${{ steps.run-dotnet.outputs.executed-command }}
  packages:
    description: "Semicolon-separated list of generated package files"
    value: ${{ steps.find-packages.outputs.packages }}
  package-count:
    description: "Number of packages generated"
    value: ${{ steps.find-packages.outputs.package-count }}
  output-directory:
    description: "Directory where packages were generated"
    value: ${{ steps.find-packages.outputs.output-directory }}

runs:
  using: "composite"
  steps:
    # ================== â„¹ï¸ ==================
    - name: "â„¹ï¸ Gather environment information"
      shell: bash
      run: |
        echo "::group::â„¹ï¸ Environment Information"
        echo "::debug::Operating System: $(uname -a)"
        echo "::debug::GitHub Runner OS: $RUNNER_OS"
        echo "::debug::GitHub Runner Version: $RUNNER_VERSION"
        echo "::debug::.NET SDK Version: $(dotnet --version || echo 'Not installed')"
        echo "::endgroup::"

    # ================== ğŸ”’ ==================
    - name: "ğŸ”’ Mask sensitive data"
      shell: bash
      run: |
        # No sensitive inputs to mask in this action
        echo "âœ… No sensitive data to mask"

    # ================== ğŸ“ ==================
    - name: "ğŸ’¯ Normalize arguments"
      id: normalize-arguments
      uses: framinosona/github_actions/normalize-arguments@main
      with:
        arguments: ${{ inputs.arguments }}

    - name: "ğŸ“ Normalize path"
      id: normalize-path
      uses: framinosona/github_actions/normalize-path@main
      with:
        path: ${{ inputs.path }}

    - name: "ğŸ“ Normalize output"
      id: normalize-output
      uses: framinosona/github_actions/normalize-path@main
      with:
        path: ${{ inputs.output }}

    - name: "ğŸ“ Normalize artifacts-path"
      id: normalize-artifacts
      uses: framinosona/github_actions/normalize-path@main
      with:
        path: ${{ inputs.artifacts-path }}

    # ================== âœ… ==================

    - name: "âœ… Validate input : path"
      if: ${{ inputs.path != '' }}
      shell: bash
      run: |
        echo "::debug::Validating path input: ${{ steps.normalize-path.outputs.normalized }}"

        if [ "${{ steps.normalize-path.outputs.exists }}" != "true" ]; then
          echo "::error file=${{ steps.normalize-path.outputs.normalized }}::Specified path does not exist: ${{ steps.normalize-path.outputs.normalized }}"
          exit 1
        fi

        echo "âœ… Path validation completed successfully"

    - name: "âœ… Validate input : booleans"
      shell: bash
      run: |
        echo "::debug::Validating boolean inputs..."
        for param in include-symbols include-source serviceable disable-build-servers use-current-runtime; do
          case $param in
            include-symbols) value="${{ inputs.include-symbols }}" ;;
            include-source) value="${{ inputs.include-source }}" ;;
            serviceable) value="${{ inputs.serviceable }}" ;;
            disable-build-servers) value="${{ inputs.disable-build-servers }}" ;;
            use-current-runtime) value="${{ inputs.use-current-runtime }}" ;;
          esac
          if [ -n "$value" ] && [ "$value" != "true" ] && [ "$value" != "false" ]; then
            echo "::error::Parameter $param must be 'true' or 'false', got: $value"
            exit 1
          fi
        done

        echo "âœ… Boolean inputs validation completed successfully"

    - name: "âœ… Validate input : version-suffix"
      if: ${{ inputs.version-suffix != '' }}
      shell: bash
      run: |
        echo "::debug::Validating version-suffix input: ${{ inputs.version-suffix }}"

        # Version suffix should not contain spaces or special characters that could break versioning
        if [[ "${{ inputs.version-suffix }}" =~ [[:space:]] ]]; then
          echo "::error::Version suffix cannot contain spaces: ${{ inputs.version-suffix }}"
          exit 1
        fi

        # Version suffix should start with alphanumeric character
        if [[ ! "${{ inputs.version-suffix }}" =~ ^[a-zA-Z0-9] ]]; then
          echo "::error::Version suffix should start with alphanumeric character: ${{ inputs.version-suffix }}"
          exit 1
        fi

        echo "âœ… Version suffix validation completed successfully"

    # ================== ğŸ—ï¸ ==================
    - name: "ğŸ—ï¸ Build argument list"
      id: build-args
      shell: bash
      run: |
        echo "::debug::Building argument list..."

        # Start with base arguments
        ARGUMENTS=""

        # Boolean flags
        for param in include-symbols include-source serviceable disable-build-servers use-current-runtime; do
          case $param in
            include-symbols) value="${{ inputs.include-symbols }}" ;;
            include-source) value="${{ inputs.include-source }}" ;;
            serviceable) value="${{ inputs.serviceable }}" ;;
            disable-build-servers) value="${{ inputs.disable-build-servers }}" ;;
            use-current-runtime) value="${{ inputs.use-current-runtime }}" ;;
          esac
          if [ "$value" = "true" ]; then
            case $param in
              use-current-runtime) ARGUMENTS="$ARGUMENTS --ucr" ;;
              *) ARGUMENTS="$ARGUMENTS --$param" ;;
            esac
          fi
        done

        # Key-value options
        for param in version-suffix; do
          case $param in
            version-suffix) value="${{ inputs.version-suffix }}" ;;
          esac
          if [ -n "$value" ]; then
            ARGUMENTS="$ARGUMENTS --$param '$value'"
          fi
        done

        # Add normalized arguments
        if [ -n "${{ steps.normalize-arguments.outputs.normalized }}" ]; then
          NORMALIZED_ARGS="${{ steps.normalize-arguments.outputs.normalized }}"
          echo "::debug::Original arguments: ${{ inputs.arguments }}"
          echo "::debug::Normalized arguments: $NORMALIZED_ARGS"
          ARGUMENTS="$ARGUMENTS $NORMALIZED_ARGS"
        fi

        # Trim leading space
        ARGUMENTS="${ARGUMENTS# }"

        # Output the final argument list
        echo "arguments=$ARGUMENTS" >> $GITHUB_OUTPUT

        echo "âœ… Argument list built successfully: $ARGUMENTS"

    # ================== ğŸš€ ==================
    - name: "ğŸ“¦ Run .NET pack"
      id: run-dotnet
      uses: "framinosona/github_actions/dotnet@main"
      with:
        command: "pack"
        path: ${{ steps.normalize-path.outputs.normalized }}
        artifacts-path: ${{ steps.normalize-artifacts.outputs.normalized }}
        output: ${{ steps.normalize-output.outputs.normalized }}
        arguments: ${{ steps.build-args.outputs.arguments }}
        working-directory: ${{ inputs.working-directory }}
        verbosity: ${{ inputs.verbosity }}
        nologo: ${{ inputs.nologo }}
        no-restore: ${{ inputs.no-restore }}
        no-build: ${{ inputs.no-build }}
        configuration: ${{ inputs.configuration }}
        show-summary: ${{ inputs.show-summary }}

    # ================== ğŸ” ==================
    - name: "ğŸ” Find generated packages"
      id: find-packages
      shell: bash
      run: |
        echo "::debug::Searching for generated NuGet packages..."

        # Determine the search directory based on inputs
        SEARCH_DIR="${{ inputs.working-directory }}"
        if [ -n "${{ steps.normalize-output.outputs.normalized }}" ]; then
          SEARCH_DIR="${{ steps.normalize-output.outputs.normalized }}"
        elif [ -n "${{ steps.normalize-artifacts.outputs.normalized }}" ]; then
          SEARCH_DIR="${{ steps.normalize-artifacts.outputs.normalized }}"
        fi

        echo "::debug::Searching in directory: $SEARCH_DIR"

        # Find all .nupkg files (including symbol packages)
        PACKAGES=""
        PACKAGE_COUNT=0

        if [ -d "$SEARCH_DIR" ]; then
          # Use find to locate .nupkg files recursively
          while IFS= read -r -d '' package; do
            if [ -z "$PACKAGES" ]; then
              PACKAGES="$package"
            else
              PACKAGES="$PACKAGES;$package"
            fi
            PACKAGE_COUNT=$((PACKAGE_COUNT + 1))
            echo "ğŸ“¦ Found package: $package"
          done < <(find "$SEARCH_DIR" -name "*.nupkg" -type f -print0 2>/dev/null)
        fi

        # Set outputs
        echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
        echo "package-count=$PACKAGE_COUNT" >> $GITHUB_OUTPUT
        echo "output-directory=$SEARCH_DIR" >> $GITHUB_OUTPUT

        if [ $PACKAGE_COUNT -eq 0 ]; then
          echo "::warning::No NuGet packages found in $SEARCH_DIR"
        else
          echo "âœ… Found $PACKAGE_COUNT NuGet package(s)"
        fi

        echo "âœ… Package discovery completed successfully"

    # ================== ğŸ“Š ==================
    - name: "ğŸ“Š Action Summary"
      if: always() && inputs.show-summary == 'true'
      shell: bash
      run: |
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        <details><summary>ğŸ“¦ .NET Pack : ${{ steps.find-packages.outputs.package-count }} package(s)</summary>

        ## ğŸ”§ Input Parameters
        | Parameter | Value |
        |-----------|-------|
        | ï¿½ Path | `${{ steps.normalize-path.outputs.normalized || 'none' }}` |
        | ğŸ“ Working Directory | `${{ inputs.working-directory }}` |
        | âš™ï¸ Configuration | `${{ inputs.configuration }}` |
        | ğŸ”§ Arguments | `${{ steps.normalize-arguments.outputs.normalized || 'none' }}` |
        | ğŸ“¤ Output Path | `${{ steps.normalize-output.outputs.normalized || 'none' }}` |
        | ğŸ—‚ï¸ Artifacts Path | `${{ steps.normalize-artifacts.outputs.normalized || 'none' }}` |
        | ï¿½ğŸ”¢ Version Suffix | `${{ inputs.version-suffix || 'none' }}` |
        | ğŸ” Include Symbols | `${{ inputs.include-symbols }}` |
        | ğŸ“ Include Source | `${{ inputs.include-source }}` |
        | âš™ï¸ Serviceable | `${{ inputs.serviceable }}` |
        | ğŸƒ Use Current Runtime | `${{ inputs.use-current-runtime }}` |
        | ğŸš« Disable Build Servers | `${{ inputs.disable-build-servers }}` |

        ## ğŸ“¦ Generated Packages
        | Metric | Value |
        |--------|-------|
        | ğŸ“Š Package Count | `${{ steps.find-packages.outputs.package-count }}` |
        | ğŸ“‚ Output Directory | `${{ steps.find-packages.outputs.output-directory }}` |
        | âœ… Exit Code | `${{ steps.run-dotnet.outputs.exit-code }}` |

        ## ğŸ“‹ Package List
        EOF

        # Add package list to summary
        if [ -n "${{ steps.find-packages.outputs.packages }}" ]; then
          IFS=';' read -ra PACKAGES <<< "${{ steps.find-packages.outputs.packages }}"
          for package in "${PACKAGES[@]}"; do
            package_name=$(basename "$package")
            echo "| ğŸ“¦ | \`$package_name\` |" >> $GITHUB_STEP_SUMMARY
          done
        else
          echo "| âš ï¸ | No packages generated |" >> $GITHUB_STEP_SUMMARY
        fi

        cat >> $GITHUB_STEP_SUMMARY << 'EOF'

        ## âš™ï¸ Process Details
        | Step | Status |
        |------|--------|
        | âœ… Input Validation | `âœ… Completed` |
        | ğŸ—ï¸ Argument Building | `${{ steps.build-args.outcome == 'success' && 'âœ… Completed' || 'âŒ Failed' }}` |
        | ğŸ“¦ Pack Execution | `${{ steps.run-dotnet.outcome == 'success' && 'âœ… Completed' || 'âŒ Failed' }}` |
        | ğŸ” Package Discovery | `${{ steps.find-packages.outcome == 'success' && 'âœ… Completed' || 'âŒ Failed' }}` |

        </details>
        EOF

branding:
  icon: "package"
  color: "blue"
