name: 'ğŸš€ CI/CD Pipeline'

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force-release:
        description: 'Force create release even if no changes'
        required: false
        default: false
        type: boolean

env:
  IS_MAIN_BRANCH: ${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}
  FORCE_RELEASE: ${{ github.event.inputs.force-release == 'true' }}

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  version:
    uses: framinosona/github_actions/generate-version/workflow.yml@main
    with:
      config-file: "./.config/version.json"
      output-txt: 'output/version/version.txt'
      output-json: 'output/version/version.json'
      output-props: 'output/version/version.props'
      show-summary: true

  build-documentation:
    name: 'ğŸ—ï¸ Build Documentation'
    needs: [version]
    runs-on: ubuntu-latest
    outputs:
      docfx-path: ${{ steps.docfx.outputs.output-path }}
      should-deploy-docs: ${{ env.IS_MAIN_BRANCH == 'true' || env.FORCE_RELEASE == 'true' }}

    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 'ğŸ“š Build Documentation'
        id: docfx
        uses: ./dotnet-docfx-build
        with:
          output: 'output/docs/site'
          show-summary: 'true'

      - name: 'ğŸ“¤ Upload GitHub Pages Artifact'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.docfx.outputs.output-path }}

  deploy-pages:
    name: 'ğŸŒ Deploy to GitHub Pages'
    if: needs.build-documentation.outputs.should-deploy-docs == 'true'
    needs: [build-documentation]
    runs-on: ubuntu-latest

    steps:
      - name: 'ğŸŒ Deploy to GitHub Pages'
        id: deployment
        uses: actions/deploy-pages@v4

  tag:
    name: 'ğŸ·ï¸ Tag Repository'
    needs: [version]
    runs-on: ubuntu-latest

    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 'ğŸ·ï¸ Create Git Tag'
        uses: ./git-tag
        with:
          tag: ${{ needs.version.outputs.version-full }}
          message: 'Release ${{ needs.version.outputs.version-full }}'
          prefix: 'v'
          fail-if-exists: 'true'
          show-summary: 'true'

  github-release:
    name: 'ğŸš€ Create GitHub Release'
    needs: [tag, version, build-documentation]
    runs-on: ubuntu-latest

    steps:
      - name: 'ğŸš€ Create GitHub Release'
        uses: ./github-release
        with:
          tag: ${{ needs.tag.outputs.tag-name }}
          title: 'Release ${{ needs.version.outputs.version-full }}'
          generate-notes: 'true'
          prerelease: ${{ needs.version.outputs.version-isprerelease }}
          show-summary: 'true'
