name: 'ðŸš€ CI/CD Pipeline'

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      major:
        description: 'Major version number'
        required: true
        default: '1'
        type: string
      minor:
        description: 'Minor version number'
        required: true
        default: '0'
        type: string
      force-release:
        description: 'Force create release even if no changes'
        required: false
        default: false
        type: boolean

env:
  MAJOR_VERSION: ${{ github.event.inputs.major || '1' }}
  MINOR_VERSION: ${{ github.event.inputs.minor || '0' }}

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-release:
    name: 'ðŸ—ï¸ Build and Release'
    runs-on: ubuntu-latest
    outputs:
      version-full: ${{ steps.version.outputs.VERSION_FULL }}
      version-tag: ${{ steps.git-tag.outputs.tag-name }}
      release-url: ${{ steps.release.outputs.release-url }}
      docfx-path: ${{ steps.docfx.outputs.output-path }}

    steps:
      - name: 'ðŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 'ðŸ”¢ Generate Version'
        id: version
        uses: ./generate-version
        with:
          major: ${{ env.MAJOR_VERSION }}
          minor: ${{ env.MINOR_VERSION }}
          output-txt: 'version.txt'
          show-summary: 'true'


      - name: 'ðŸ·ï¸ Generate Version Badge'
        id: badge
        uses: ./generate-badge
        with:
          label: 'version'
          message: ${{ steps.version.outputs.VERSION_FULL }}
          logo: 'github'
          output-file: 'version-badge.svg'
          output-format: 'svg'
          show-summary: 'true'

      - name: 'ðŸ“š Build Documentation'
        id: docfx
        uses: ./dotnet-docfx-build
        with:
          metadata: '{"_appTitle":"GitHub Actions Repository","_appFooter":"Â© 2024 Francois Raminosona","_enableSearch":"true"}'
          show-summary: 'true'

      - name: 'ðŸ“ Prepare Site Assets'
        shell: bash
        run: |
          echo "ðŸ“ Preparing site assets for GitHub Pages..."

          # Create assets directory in site output
          mkdir -p ${{ steps.docfx.outputs.output-path }}/assets

          # Copy version files to site
          if [ -f "version.txt" ]; then
            cp version.txt ${{ steps.docfx.outputs.output-path }}/assets/
            echo "âœ… Copied version.txt to site assets"
          fi

          # Copy SVG badge to site assets
          if [ -f "version-badge.svg" ]; then
            cp version-badge.svg ${{ steps.docfx.outputs.output-path }}/assets/
            echo "âœ… Copied version-badge.svg to site assets"
          fi

          # Copy SVG badge to site assets
          if [ -f "version-badge.svg" ]; then
            cp version-badge.svg ${{ steps.docfx.outputs.output-path }}/assets/
            echo "âœ… Copied version-badge.svg to site assets"
          fi

          # Create version JSON for JavaScript consumption
          cat > ${{ steps.docfx.outputs.output-path }}/assets/version.json << EOF
          {
            "major": "${{ steps.version.outputs.VERSION_MAJOR }}",
            "minor": "${{ steps.version.outputs.VERSION_MINOR }}",
            "patch": "${{ steps.version.outputs.VERSION_PATCH }}",
            "full": "${{ steps.version.outputs.VERSION_FULL }}",
            "core": "${{ steps.version.outputs.VERSION_CORE }}",
            "assembly": "${{ steps.version.outputs.VERSION_ASSEMBLY }}",
            "buildId": "${{ steps.version.outputs.VERSION_BUILDID }}",
            "branchName": "${{ steps.version.outputs.VERSION_BRANCHNAME }}",
            "releaseUrl": "${{ steps.release.outputs.release-url || '' }}",
            "badgeFile": "assets/version-badge.svg"
          }
          EOF
          echo "âœ… Created version.json for site"

          echo "âœ… Site assets preparation completed"

      - name: 'ðŸ“¤ Upload GitHub Pages Artifact'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.docfx.outputs.output-path }}

      - name: 'ðŸ·ï¸ Create Git Tag'
        id: git-tag
        if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch) || github.event.inputs.force-release == 'true'
        uses: ./git-tag
        with:
          tag: ${{ steps.version.outputs.VERSION_FULL }}
          message: 'Release ${{ steps.version.outputs.VERSION_FULL }}'
          prefix: 'v'
          fail-if-exists: 'false'
          show-summary: 'true'

      - name: 'ðŸš€ Create GitHub Release'
        id: release
        if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch) || github.event.inputs.force-release == 'true'
        uses: ./github-release
        with:
          tag: ${{ steps.git-tag.outputs.tag-name }}
          title: 'Release ${{ steps.version.outputs.VERSION_FULL }}'
          generate-notes: 'true'
          prerelease: ${{ contains(steps.version.outputs.VERSION_FULL, '-') }}
          show-summary: 'true'

      - name: 'ðŸ“‹ Workflow Summary'
        shell: bash
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸš€ CI/CD Pipeline Summary

          ## ðŸ“Š Build Results
          | Component | Status | Details |
          |-----------|--------|---------|
          | ðŸ”¢ Version Generation | âœ… | `${{ steps.version.outputs.VERSION_FULL }}` |
          | ðŸ·ï¸ Git Tagging | ${{ steps.git-tag.outcome == 'success' && 'âœ…' || (steps.git-tag.outcome == 'skipped' && 'â­ï¸' || 'âŒ') }} | `${{ steps.git-tag.outputs.tag-name || 'skipped' }}` |
          | ðŸ·ï¸ Badge Generation | âœ… | SVG file created |
          | ðŸš€ GitHub Release | ${{ steps.release.outcome == 'success' && 'âœ…' || (steps.release.outcome == 'skipped' && 'â­ï¸' || 'âŒ') }} | ${{ steps.release.outputs.release-url && format('[Release]({0})', steps.release.outputs.release-url) || 'skipped' }} |
          | ðŸ“š Documentation | âœ… | ${{ steps.docfx.outputs.files-count }} files generated |

          ## ðŸ”— Quick Links
          - ðŸ“¦ **Version**: `${{ steps.version.outputs.VERSION_FULL }}`
          - ðŸ·ï¸ **Badge**: Available at `/assets/version-badge.svg`
          - ðŸŒ **Documentation**: Will be available at GitHub Pages after deployment
          ${{ steps.release.outputs.release-url && format('- ðŸš€ **Release**: [View Release]({0})', steps.release.outputs.release-url) || '' }}

          ## ðŸ“ Generated Assets
          - `version.txt` - Version information in key=value format
          - `version.json` - Version information in JSON format
          - `version-badge.svg` - Version badge in SVG format
          - Documentation site in `${{ steps.docfx.outputs.output-path }}`
          EOF

  deploy-pages:
    name: 'ðŸŒ Deploy to GitHub Pages'
    needs: build-and-release
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: 'ðŸŒ Deploy to GitHub Pages'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: 'ðŸ“‹ Deployment Summary'
        shell: bash
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸŒ GitHub Pages Deployment

          ## ðŸš€ Deployment Results
          | Component | Status | URL |
          |-----------|--------|-----|
          | ðŸ“š Documentation Site | âœ… | [${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }}) |
          | ðŸ·ï¸ Version Badge | âœ… | [${{ steps.deployment.outputs.page_url }}assets/version-badge.svg](${{ steps.deployment.outputs.page_url }}assets/version-badge.svg) |
          | ðŸ“„ Version Info | âœ… | [${{ steps.deployment.outputs.page_url }}assets/version.json](${{ steps.deployment.outputs.page_url }}assets/version.json) |

          ## ðŸ“‹ Available Resources
          - **Main Documentation**: [${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }})
          - **Version Badge**: [${{ steps.deployment.outputs.page_url }}assets/version-badge.svg](${{ steps.deployment.outputs.page_url }}assets/version-badge.svg)
          - **Version**: `${{ needs.build-and-release.outputs.version-full }}`
          ${{ needs.build-and-release.outputs.release-url && format('- **Latest Release**: [View Release]({0})', needs.build-and-release.outputs.release-url) || '' }}
          EOF
