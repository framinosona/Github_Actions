name: 'ðŸ§ª Test Normalize Arguments Action'

on:
  push:
    paths:
      - 'normalize-arguments/**'
      - '.github/workflows/test-normalize-arguments.yml'
  pull_request:
    paths:
      - 'normalize-arguments/**'
      - '.github/workflows/test-normalize-arguments.yml'
  workflow_dispatch:
    inputs:
      show-summary:
        description: 'Show detailed action summaries'
        required: false
        default: true
        type: boolean
      test-platform:
        description: 'Platform to test (all, linux, windows, macos)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - linux
          - windows
          - macos

env:
  SHOW_SUMMARY: ${{ github.event.inputs.show-summary || 'true' }}

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-strategy:
    name: 'ðŸŽ¯ Determine Test Strategy'
    runs-on: ubuntu-latest
    outputs:
      test-linux: ${{ steps.strategy.outputs.test-linux }}
      test-windows: ${{ steps.strategy.outputs.test-windows }}
      test-macos: ${{ steps.strategy.outputs.test-macos }}
    steps:
      - name: 'ðŸŽ¯ Set Test Strategy'
        id: strategy
        shell: bash
        run: |
          TEST_PLATFORM="${{ github.event.inputs.test-platform || 'all' }}"

          case "$TEST_PLATFORM" in
            "all")
              echo "test-linux=true" >> $GITHUB_OUTPUT
              echo "test-windows=true" >> $GITHUB_OUTPUT
              echo "test-macos=true" >> $GITHUB_OUTPUT
              ;;
            "linux")
              echo "test-linux=true" >> $GITHUB_OUTPUT
              echo "test-windows=false" >> $GITHUB_OUTPUT
              echo "test-macos=false" >> $GITHUB_OUTPUT
              ;;
            "windows")
              echo "test-linux=false" >> $GITHUB_OUTPUT
              echo "test-windows=true" >> $GITHUB_OUTPUT
              echo "test-macos=false" >> $GITHUB_OUTPUT
              ;;
            "macos")
              echo "test-linux=false" >> $GITHUB_OUTPUT
              echo "test-windows=false" >> $GITHUB_OUTPUT
              echo "test-macos=true" >> $GITHUB_OUTPUT
              ;;
          esac

          echo "::notice::Testing strategy: $TEST_PLATFORM"

  test-linux:
    name: 'ðŸ§ Test on Linux'
    if: needs.test-strategy.outputs.test-linux == 'true'
    needs: [test-strategy]
    runs-on: ubuntu-latest
    steps:
      - name: 'ðŸ“¥ Checkout Repository'
        uses: actions/checkout@v5

      - name: 'ðŸ§ª Test Single-line Arguments'
        id: test-single-line
        uses: ./normalize-arguments
        with:
          arguments: '--verbose --configuration Release --no-restore'
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Single-line Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Single-line Test Results"
          EXPECTED="--verbose --configuration Release --no-restore"
          ACTUAL="${{ steps.test-single-line.outputs.normalized-arguments }}"
          IS_EMPTY="${{ steps.test-single-line.outputs.is-empty }}"

          echo "Expected: $EXPECTED"
          echo "Actual: $ACTUAL"
          echo "Is Empty: $IS_EMPTY"

          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::Single-line test failed. Expected '$EXPECTED', got '$ACTUAL'"
            exit 1
          fi

          if [ "$IS_EMPTY" != "false" ]; then
            echo "::error::Single-line empty test failed. Expected 'false', got '$IS_EMPTY'"
            exit 1
          fi

          echo "::notice::âœ… Single-line test passed successfully"
          echo "::endgroup::"

      - name: 'ðŸ§ª Test Multi-line Arguments (Literal Block Scalar |)'
        id: test-multiline
        uses: ./normalize-arguments
        with:
          arguments: |
            --verbose
            --configuration
            Release
            --no-restore
            --output
            ./bin/Release
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Multi-line Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Multi-line Test Results"
          EXPECTED="--verbose --configuration Release --no-restore --output ./bin/Release"
          ACTUAL="${{ steps.test-multiline.outputs.normalized-arguments }}"
          IS_EMPTY="${{ steps.test-multiline.outputs.is-empty }}"

          echo "Expected: $EXPECTED"
          echo "Actual: $ACTUAL"
          echo "Is Empty: $IS_EMPTY"

          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::Multi-line test failed. Expected '$EXPECTED', got '$ACTUAL'"
            exit 1
          fi

          if [ "$IS_EMPTY" != "false" ]; then
            echo "::error::Multi-line empty test failed. Expected 'false', got '$IS_EMPTY'"
            exit 1
          fi

          echo "::notice::âœ… Multi-line test passed successfully"
          echo "::endgroup::"

      - name: 'ðŸ§ª Test Folded Arguments (Folded Block Scalar >)'
        id: test-folded
        uses: ./normalize-arguments
        with:
          arguments: >
            --verbose
            --configuration Release
            --no-restore
            --output ./bin/Release
            --framework net8.0
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Folded Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Folded Test Results"
          EXPECTED="--verbose --configuration Release --no-restore --output ./bin/Release --framework net8.0"
          ACTUAL="${{ steps.test-folded.outputs.normalized-arguments }}"
          IS_EMPTY="${{ steps.test-folded.outputs.is-empty }}"

          echo "Expected: $EXPECTED"
          echo "Actual: $ACTUAL"
          echo "Is Empty: $IS_EMPTY"

          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::Folded test failed. Expected '$EXPECTED', got '$ACTUAL'"
            exit 1
          fi

          if [ "$IS_EMPTY" != "false" ]; then
            echo "::error::Folded empty test failed. Expected 'false', got '$IS_EMPTY'"
            exit 1
          fi

          echo "::notice::âœ… Folded test passed successfully"
          echo "::endgroup::"

      - name: 'ðŸ§ª Test Custom Separator'
        id: test-separator
        uses: ./normalize-arguments
        with:
          arguments: |
            arg1
            arg2
            arg3
          separator: ','
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Separator Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Separator Test Results"
          EXPECTED="arg1,arg2,arg3"
          ACTUAL="${{ steps.test-separator.outputs.normalized-arguments }}"

          echo "Expected: $EXPECTED"
          echo "Actual: $ACTUAL"

          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::Separator test failed. Expected '$EXPECTED', got '$ACTUAL'"
            exit 1
          fi

          echo "::notice::âœ… Separator test passed successfully"
          echo "::endgroup::"

      - name: 'ðŸ§ª Test Empty Arguments'
        id: test-empty
        uses: ./normalize-arguments
        with:
          arguments: |



          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Empty Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Empty Test Results"
          ACTUAL="${{ steps.test-empty.outputs.normalized-arguments }}"
          IS_EMPTY="${{ steps.test-empty.outputs.is-empty }}"

          echo "Actual: '$ACTUAL'"
          echo "Is Empty: $IS_EMPTY"

          if [ -n "$ACTUAL" ]; then
            echo "::error::Empty test failed. Expected empty string, got '$ACTUAL'"
            exit 1
          fi

          if [ "$IS_EMPTY" != "true" ]; then
            echo "::error::Empty flag test failed. Expected 'true', got '$IS_EMPTY'"
            exit 1
          fi

          echo "::notice::âœ… Empty test passed successfully"
          echo "::endgroup::"

      - name: 'ðŸ§ª Test Null/Missing Arguments'
        id: test-null
        uses: ./normalize-arguments
        with:
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Null Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Null Arguments Test Results"
          ACTUAL="${{ steps.test-null.outputs.normalized-arguments }}"
          IS_EMPTY="${{ steps.test-null.outputs.is-empty }}"

          echo "Actual: '$ACTUAL'"
          echo "Is Empty: $IS_EMPTY"

          if [ -n "$ACTUAL" ]; then
            echo "::error::Null test failed. Expected empty string, got '$ACTUAL'"
            exit 1
          fi

          if [ "$IS_EMPTY" != "true" ]; then
            echo "::error::Null flag test failed. Expected 'true', got '$IS_EMPTY'"
            exit 1
          fi

          echo "::notice::âœ… Null test passed successfully"
          echo "::endgroup::"

  test-windows:
    name: 'ðŸªŸ Test on Windows'
    if: needs.test-strategy.outputs.test-windows == 'true'
    needs: [test-strategy]
    runs-on: windows-latest
    steps:
      - name: 'ðŸ“¥ Checkout Repository'
        uses: actions/checkout@v5

      - name: 'ðŸ§ª Test Windows-specific Arguments'
        id: test-windows-args
        uses: ./normalize-arguments
        with:
          arguments: |
            /p:Configuration=Release
            /p:Platform="Any CPU"
            /p:OutputPath=C:\Build\Output
            /verbosity:minimal
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Windows Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Windows Test Results"
          EXPECTED='/p:Configuration=Release /p:Platform="Any CPU" /p:OutputPath=C:\Build\Output /verbosity:minimal'
          ACTUAL="${{ steps.test-windows-args.outputs.normalized-arguments }}"

          echo "Expected: $EXPECTED"
          echo "Actual: $ACTUAL"

          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::Windows test failed. Expected '$EXPECTED', got '$ACTUAL'"
            exit 1
          fi

          echo "::notice::âœ… Windows test passed successfully"
          echo "::endgroup::"

      - name: 'ðŸ§ª Test PowerShell-style Arguments'
        id: test-powershell
        uses: ./normalize-arguments
        with:
          arguments: >
            -Configuration Release
            -Platform "Any CPU"
            -OutputPath "C:\Build\Output"
            -Verbosity minimal
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify PowerShell Results'
        shell: bash
        run: |
          echo "::group::ðŸ” PowerShell Test Results"
          EXPECTED='-Configuration Release -Platform "Any CPU" -OutputPath "C:\Build\Output" -Verbosity minimal'
          ACTUAL="${{ steps.test-powershell.outputs.normalized-arguments }}"

          echo "Expected: $EXPECTED"
          echo "Actual: $ACTUAL"

          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::PowerShell test failed. Expected '$EXPECTED', got '$ACTUAL'"
            exit 1
          fi

          echo "::notice::âœ… PowerShell test passed successfully"
          echo "::endgroup::"

  test-macos:
    name: 'ðŸŽ Test on macOS'
    if: needs.test-strategy.outputs.test-macos == 'true'
    needs: [test-strategy]
    runs-on: macos-latest
    steps:
      - name: 'ðŸ“¥ Checkout Repository'
        uses: actions/checkout@v5

      - name: 'ðŸ§ª Test macOS-specific Arguments'
        id: test-macos-args
        uses: ./normalize-arguments
        with:
          arguments: |
            --configuration
            Release
            --runtime
            osx-x64
            --self-contained
            true
            --output
            /Users/runner/build
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify macOS Results'
        shell: bash
        run: |
          echo "::group::ðŸ” macOS Test Results"
          EXPECTED="--configuration Release --runtime osx-x64 --self-contained true --output /Users/runner/build"
          ACTUAL="${{ steps.test-macos-args.outputs.normalized-arguments }}"

          echo "Expected: $EXPECTED"
          echo "Actual: $ACTUAL"

          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::macOS test failed. Expected '$EXPECTED', got '$ACTUAL'"
            exit 1
          fi

          echo "::notice::âœ… macOS test passed successfully"
          echo "::endgroup::"

      - name: 'ðŸ§ª Test Unix-style Arguments'
        id: test-unix
        uses: ./normalize-arguments
        with:
          arguments: >
            -c Release
            -r osx-arm64
            -o ~/build
            --self-contained
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Unix Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Unix Test Results"
          EXPECTED="-c Release -r osx-arm64 -o ~/build --self-contained"
          ACTUAL="${{ steps.test-unix.outputs.normalized-arguments }}"

          echo "Expected: $EXPECTED"
          echo "Actual: $ACTUAL"

          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::Unix test failed. Expected '$EXPECTED', got '$ACTUAL'"
            exit 1
          fi

          echo "::notice::âœ… Unix test passed successfully"
          echo "::endgroup::"

  test-integration:
    name: 'ðŸ”— Integration Tests'
    needs: [test-strategy, test-linux]
    if: always() && needs.test-strategy.outputs.test-linux == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: 'ðŸ“¥ Checkout Repository'
        uses: actions/checkout@v5

      - name: 'ðŸ§ª Test with dotnet command'
        id: test-dotnet
        uses: ./normalize-arguments
        with:
          arguments: |
            build
            --configuration
            Release
            --no-restore
            --verbosity
            minimal
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'ðŸ”§ Execute dotnet command (dry run)'
        shell: bash
        run: |
          echo "::group::ðŸš€ Integration Test - dotnet command"
          DOTNET_ARGS="${{ steps.test-dotnet.outputs.normalized-arguments }}"
          echo "Generated arguments: $DOTNET_ARGS"
          echo "Would execute: dotnet $DOTNET_ARGS"

          # Verify the command structure is valid
          if [[ "$DOTNET_ARGS" =~ ^build[[:space:]]--configuration[[:space:]]Release[[:space:]]--no-restore[[:space:]]--verbosity[[:space:]]minimal$ ]]; then
            echo "::notice::âœ… Integration test passed - Command structure is valid"
          else
            echo "::error::Integration test failed - Invalid command structure"
            exit 1
          fi
          echo "::endgroup::"

      - name: 'ðŸ§ª Test with complex build command'
        id: test-complex
        uses: ./normalize-arguments
        with:
          arguments: |
            --configuration Release
            --runtime linux-x64
            --self-contained true
            --output ./dist/linux-x64
            --verbosity normal
            /p:PublishSingleFile=true
            /p:PublishTrimmed=true
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'ðŸ”§ Execute complex build (dry run)'
        shell: bash
        run: |
          echo "::group::ðŸš€ Integration Test - complex build"
          BUILD_ARGS="${{ steps.test-complex.outputs.normalized-arguments }}"
          echo "Generated arguments: $BUILD_ARGS"
          echo "Would execute: dotnet publish $BUILD_ARGS"

          # Verify all expected arguments are present
          if [[ "$BUILD_ARGS" == *"--configuration Release"* ]] && \
             [[ "$BUILD_ARGS" == *"--runtime linux-x64"* ]] && \
             [[ "$BUILD_ARGS" == *"--self-contained true"* ]] && \
             [[ "$BUILD_ARGS" == *"--output ./dist/linux-x64"* ]] && \
             [[ "$BUILD_ARGS" == *"--verbosity normal"* ]] && \
             [[ "$BUILD_ARGS" == *"/p:PublishSingleFile=true"* ]] && \
             [[ "$BUILD_ARGS" == *"/p:PublishTrimmed=true"* ]]; then
            echo "::notice::âœ… Complex integration test passed - All expected arguments present"
          else
            echo "::error::Complex integration test failed - Missing expected arguments"
            echo "::error::Got: $BUILD_ARGS"
            exit 1
          fi
          echo "::endgroup::"

  test-summary:
    name: 'ðŸ“‹ Test Summary'
    if: always()
    needs: [test-strategy, test-linux, test-windows, test-macos, test-integration]
    runs-on: ubuntu-latest
    steps:
      - name: 'ðŸ“Š Generate Test Summary'
        shell: bash
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ§ª Normalize Arguments Action Test Results

          ## ðŸ“‹ Test Execution Summary
          | Platform | Status | Details |
          |----------|--------|---------|
          | ðŸ§ Linux | ${{ needs.test-linux.result == 'success' && 'âœ… Passed' || needs.test-linux.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | Core functionality, all argument types |
          | ðŸªŸ Windows | ${{ needs.test-windows.result == 'success' && 'âœ… Passed' || needs.test-windows.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | Windows-specific paths and PowerShell |
          | ðŸŽ macOS | ${{ needs.test-macos.result == 'success' && 'âœ… Passed' || needs.test-macos.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | Unix-style arguments and macOS paths |
          | ðŸ”— Integration | ${{ needs.test-integration.result == 'success' && 'âœ… Passed' || needs.test-integration.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | Real-world usage scenarios |

          ## ðŸ§ª Test Categories Covered
          - **Single-line arguments**: Direct string input
          - **Multi-line arguments (|)**: Literal block scalar with newlines
          - **Folded arguments (>)**: Folded block scalar (spaces between words)
          - **Custom separators**: Using comma, space, and other delimiters
          - **Empty handling**: Blank inputs and automatic sanitization
          - **Platform-specific**: Windows paths, PowerShell, Unix-style args
          - **Integration**: Real dotnet command scenarios

          ## ðŸŽ¯ Key Features Tested
          - âœ… Input validation and error handling
          - âœ… Empty result detection
          - âœ… Automatic whitespace trimming and sanitization
          - âœ… Custom separator support
          - âœ… Cross-platform compatibility
          - âœ… YAML scalar type handling (|, >, plain)
          - âœ… Output format consistency

          ## ðŸ“¤ Action Outputs Verified
          - `normalized-arguments`: Properly formatted single-line string
          - `is-empty`: Correct empty state detection

          ---
          *Test completed on: ${{ github.run_number }} | Triggered by: ${{ github.event_name }}*
          EOF

          # Check overall success
          LINUX_STATUS="${{ needs.test-linux.result }}"
          WINDOWS_STATUS="${{ needs.test-windows.result }}"
          MACOS_STATUS="${{ needs.test-macos.result }}"
          INTEGRATION_STATUS="${{ needs.test-integration.result }}"

          FAILED_TESTS=""

          if [ "$LINUX_STATUS" = "failure" ]; then
            FAILED_TESTS="$FAILED_TESTS Linux"
          fi

          if [ "$WINDOWS_STATUS" = "failure" ]; then
            FAILED_TESTS="$FAILED_TESTS Windows"
          fi

          if [ "$MACOS_STATUS" = "failure" ]; then
            FAILED_TESTS="$FAILED_TESTS macOS"
          fi

          if [ "$INTEGRATION_STATUS" = "failure" ]; then
            FAILED_TESTS="$FAILED_TESTS Integration"
          fi

          if [ -n "$FAILED_TESTS" ]; then
            echo "::error::Tests failed on:$FAILED_TESTS"
            exit 1
          else
            echo "::notice::ðŸŽ‰ All tests passed successfully!"
          fi
