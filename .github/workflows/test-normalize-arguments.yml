name: 'ðŸ§ª Test Normalize Arguments Action'

on:
  push:
    paths:
      - 'normalize-arguments/**'
      - '.github/workflows/test-normalize-arguments.yml'
  pull_request:
    paths:
      - 'normalize-arguments/**'
      - '.github/workflows/test-normalize-arguments.yml'
  workflow_dispatch:
    inputs:
      show-summary:
        description: 'Show detailed action summaries'
        required: false
        default: true
        type: boolean

env:
  SHOW_SUMMARY: ${{ github.event.inputs.show-summary || 'true' }}

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-cross-platform:
    name: '${{ matrix.icon }} Test on ${{ matrix.platform }}'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: 'Linux'
            icon: 'ðŸ§'
          - os: windows-latest
            platform: 'Windows'
            icon: 'ðŸªŸ'
          - os: macos-latest
            platform: 'macOS'
            icon: 'ðŸŽ'
    steps:
      - name: 'ðŸ“¥ Checkout Repository'
        uses: actions/checkout@v5

      - name: 'ðŸ§ª Test Single-line Arguments'
        id: test-single-line
        uses: ./normalize-arguments
        with:
          arguments: '--verbose --configuration Release --no-restore'
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Single-line Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Single-line Test on ${{ matrix.platform }}"
          EXPECTED="--verbose --configuration Release --no-restore"
          ACTUAL="${{ steps.test-single-line.outputs.normalized-arguments }}"
          echo "Expected: $EXPECTED"
          echo "Actual: $ACTUAL"
          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::Expected '$EXPECTED', got '$ACTUAL'"
            exit 1
          fi
          echo "::notice::âœ… Test passed"
          echo "::endgroup::"

      - name: 'ðŸ§ª Test Multi-line Arguments (Literal Block Scalar |)'
        id: test-multiline
        uses: ./normalize-arguments
        with:
          arguments: |
            --env
            "NODE_ENV=production"
            --env
            "PORT=3000"
            --volume
            "data:/app/data"
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Multi-line Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Multi-line (|) Test on ${{ matrix.platform }}"
          EXPECTED='--env "NODE_ENV=production" --env "PORT=3000" --volume "data:/app/data"'
          ACTUAL="${{ steps.test-multiline.outputs.normalized-arguments }}"
          echo "Expected: $EXPECTED"
          echo "Actual: $ACTUAL"
          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::Expected '$EXPECTED', got '$ACTUAL'"
            exit 1
          fi
          echo "::notice::âœ… Test passed"
          echo "::endgroup::"

      - name: 'ðŸ§ª Test Folded Arguments (Folded Block Scalar >)'
        id: test-folded
        uses: ./normalize-arguments
        with:
          arguments: >
            --param "value with spaces"
            --flag
            --option "another value"
            --count 42
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Folded Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Folded (>) Test on ${{ matrix.platform }}"
          EXPECTED='--param "value with spaces" --flag --option "another value" --count 42'
          ACTUAL="${{ steps.test-folded.outputs.normalized-arguments }}"
          echo "Expected: $EXPECTED"
          echo "Actual: $ACTUAL"
          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::Expected '$EXPECTED', got '$ACTUAL'"
            exit 1
          fi
          echo "::notice::âœ… Test passed"
          echo "::endgroup::"

      - name: 'ðŸ§ª Test Empty Lines in Multi-line'
        id: test-empty-lines
        uses: ./normalize-arguments
        with:
          arguments: |
            --verbose

            --configuration
            Release

            --no-restore
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Empty Lines Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Empty Lines Test on ${{ matrix.platform }}"
          EXPECTED='--verbose --configuration Release --no-restore'
          ACTUAL="${{ steps.test-empty-lines.outputs.normalized-arguments }}"
          echo "Expected: $EXPECTED"
          echo "Actual: $ACTUAL"
          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::Expected '$EXPECTED', got '$ACTUAL'"
            exit 1
          fi
          echo "::notice::âœ… Test passed"
          echo "::endgroup::"

      - name: 'ðŸ§ª Test Completely Empty Arguments'
        id: test-empty
        uses: ./normalize-arguments
        with:
          arguments: |



          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Empty Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Empty Arguments Test on ${{ matrix.platform }}"
          ACTUAL="${{ steps.test-empty.outputs.normalized-arguments }}"
          echo "Actual: '$ACTUAL'"
          if [ -n "$ACTUAL" ]; then
            echo "::error::Expected empty string, got '$ACTUAL'"
            exit 1
          fi
          echo "::notice::âœ… Test passed"
          echo "::endgroup::"

      - name: 'ðŸ§ª Test Null/Missing Arguments'
        id: test-null
        uses: ./normalize-arguments
        with:
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Null Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Null Arguments Test on ${{ matrix.platform }}"
          ACTUAL="${{ steps.test-null.outputs.normalized-arguments }}"
          echo "Actual: '$ACTUAL'"
          if [ -n "$ACTUAL" ]; then
            echo "::error::Expected empty string, got '$ACTUAL'"
            exit 1
          fi
          echo "::notice::âœ… Test passed"
          echo "::endgroup::"

      - name: 'ðŸ§ª Test Custom Separator'
        id: test-separator
        uses: ./normalize-arguments
        with:
          arguments: |
            arg1
            arg2
            arg3
          separator: ','
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Custom Separator Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Custom Separator Test on ${{ matrix.platform }}"
          EXPECTED="arg1,arg2,arg3"
          ACTUAL="${{ steps.test-separator.outputs.normalized-arguments }}"
          echo "Expected: $EXPECTED"
          echo "Actual: $ACTUAL"
          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::Expected '$EXPECTED', got '$ACTUAL'"
            exit 1
          fi
          echo "::notice::âœ… Test passed"
          echo "::endgroup::"

      - name: 'ðŸ§ª Test Arguments with Quotes'
        id: test-quotes
        uses: ./normalize-arguments
        with:
          arguments: |
            --name "My Project"
            --description "A test application"
            --version "1.0.0-beta"
          separator: ' '
          show-summary: ${{ env.SHOW_SUMMARY }}

      - name: 'âœ… Verify Quoted Arguments Results'
        shell: bash
        run: |
          echo "::group::ðŸ” Quoted Arguments Test on ${{ matrix.platform }}"
          EXPECTED='--name "My Project" --description "A test application" --version "1.0.0-beta"'
          ACTUAL="${{ steps.test-quotes.outputs.normalized-arguments }}"
          echo "Expected: $EXPECTED"
          echo "Actual: $ACTUAL"
          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::Expected '$EXPECTED', got '$ACTUAL'"
            exit 1
          fi
          echo "::notice::âœ… Test passed"
          echo "::endgroup::"

  test-summary:
    name: 'ðŸ“‹ Test Summary'
    if: always()
    needs: [test-cross-platform]
    runs-on: ubuntu-latest
    steps:
      - name: 'ðŸ“Š Generate Test Summary'
        shell: bash
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ§ª Normalize Arguments Action Test Results

          ## ðŸ“‹ Test Execution Summary
          | Platform | Status |
          |----------|--------|
          | ðŸ§ Linux | ${{ needs.test-cross-platform.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          | ðŸªŸ Windows | ${{ needs.test-cross-platform.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          | ðŸŽ macOS | ${{ needs.test-cross-platform.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |

          ## ðŸ§ª Test Categories Covered
          - âœ… Single-line arguments
          - âœ… Multi-line arguments with literal block scalar (`|`)
          - âœ… Folded arguments with folded block scalar (`>`)
          - âœ… Empty lines in multi-line input
          - âœ… Completely empty arguments
          - âœ… Null/missing arguments
          - âœ… Custom separators
          - âœ… Arguments with quotes
          - âœ… Cross-platform compatibility

          ## ðŸ“¤ Tested Features
          - Automatic whitespace trimming
          - Newline to separator conversion
          - Empty line removal
          - Quote preservation
          - Custom separator support

          ---
          *Test completed on: ${{ github.run_number }}*
          EOF

          if [ "${{ needs.test-cross-platform.result }}" != "success" ]; then
            echo "::error::Tests failed"
            exit 1
          else
            echo "::notice::ðŸŽ‰ All tests passed!"
          fi
